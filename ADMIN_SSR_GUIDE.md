# Admin Dashboard æœåŠ¡ç«¯æ¸²æŸ“æŒ‡å—

æœ¬é¡¹ç›®çš„ Admin Dashboard å·²å‡çº§ä¸ºæœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ï¼Œå¹¶å®ç°äº†æ™ºèƒ½ç¼“å­˜æœºåˆ¶ã€‚

## ğŸš€ ç‰¹æ€§

### 1. **æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰**

- æ•°æ®åœ¨æœåŠ¡ç«¯è·å–ï¼Œé¦–å±åŠ è½½æ›´å¿«
- SEO å‹å¥½ï¼ˆè™½ç„¶ç®¡ç†åå°é€šå¸¸ä¸éœ€è¦ SEOï¼‰
- å‡å°‘å®¢æˆ·ç«¯ JavaScript è´Ÿæ‹…

### 2. **è‡ªåŠ¨ç¼“å­˜åˆ·æ–°**

- æ•°æ®ç¼“å­˜ 60 ç§’è‡ªåŠ¨åˆ·æ–°
- ä½¿ç”¨ Next.js çš„ `unstable_cache` å’Œ `revalidate`
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½

### 3. **æ‰‹åŠ¨åˆ·æ–°**

- æä¾›æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
- ä½¿ç”¨ `router.refresh()` ç«‹å³æ›´æ–°æ•°æ®
- ä¼˜é›…çš„åŠ è½½çŠ¶æ€æç¤º

## ğŸ“ æ–‡ä»¶ç»“æ„

```
lib/
  â”œâ”€â”€ admin-data.ts          # æœåŠ¡ç«¯æ•°æ®è·å–å‡½æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
  â””â”€â”€ logger.ts              # æ—¥å¿—å·¥å…·

app/
  â””â”€â”€ [locale]/
      â”œâ”€â”€ (main)/
      â”‚   â””â”€â”€ admin/
      â”‚       â””â”€â”€ page.tsx   # Admin é¡µé¢ï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰
      â””â”€â”€ ui/
          â””â”€â”€ admin/
              â”œâ”€â”€ dashboard.tsx       # Dashboard ç»„ä»¶ï¼ˆæœåŠ¡ç«¯ï¼‰
              â””â”€â”€ refresh-button.tsx  # åˆ·æ–°æŒ‰é’®ï¼ˆå®¢æˆ·ç«¯ï¼‰
```

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. æ•°æ®è·å–å‡½æ•° (`lib/admin-data.ts`)

```typescript
export const getAdminStats = unstable_cache(
  async (): Promise<AdminStats> => {
    // ä»æ•°æ®åº“è·å–ç»Ÿè®¡æ•°æ®
    const [totalUsers, totalSessions, adminUsers] = await Promise.all([
      prisma.user.count(),
      prisma.session.count(),
      prisma.user.count({ where: { role: "ADMIN" } }),
    ]);
    return { totalUsers, totalSessions, adminUsers };
  },
  ["admin-stats"], // ç¼“å­˜é”®
  {
    revalidate: 60, // 60ç§’åé‡æ–°éªŒè¯
    tags: ["admin-stats"], // ç”¨äºæ‰‹åŠ¨åˆ·æ–°
  }
);
```

### 2. é¡µé¢ç»„ä»¶ (`app/[locale]/(main)/admin/page.tsx`)

```typescript
// è®¾ç½®é¡µé¢é‡æ–°éªŒè¯æ—¶é—´
export const revalidate = 60;

export default async function AdminPage() {
  // æƒé™æ£€æŸ¥
  const user = await getCurrentUser();
  if (!user) redirect("/");

  // è·å–æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
  const { stats, users } = await getAdminDashboardData();

  // ä¼ é€’ç»™å±•ç¤ºç»„ä»¶
  return <AdminDashboard user={user} stats={stats} users={users} />;
}
```

### 3. æ‰‹åŠ¨åˆ·æ–° (`app/[locale]/ui/admin/refresh-button.tsx`)

```typescript
"use client";

export default function AdminRefreshButton() {
  const router = useRouter();

  const handleRefresh = () => {
    router.refresh(); // åˆ·æ–°æœåŠ¡ç«¯æ•°æ®
  };

  return <button onClick={handleRefresh}>åˆ·æ–°æ•°æ®</button>;
}
```

## âš™ï¸ ç¼“å­˜é…ç½®

### è‡ªåŠ¨åˆ·æ–°é—´éš”

åœ¨ `lib/admin-data.ts` ä¸­ä¿®æ”¹ `revalidate` å€¼ï¼š

```typescript
{
  revalidate: 60,  // æ”¹ä¸ºå…¶ä»–ç§’æ•°ï¼Œå¦‚ 30ã€120 ç­‰
}
```

åœ¨ `app/[locale]/(main)/admin/page.tsx` ä¸­åŒæ­¥ä¿®æ”¹ï¼š

```typescript
export const revalidate = 60; // ä¸æ•°æ®å‡½æ•°ä¿æŒä¸€è‡´
```

### æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜

å¦‚æœéœ€è¦ç«‹å³æ›´æ–°æ•°æ®ï¼ˆå¦‚åˆ›å»ºæ–°ç”¨æˆ·åï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```typescript
import { revalidateTag } from "next/cache";

// æ¸…é™¤ç‰¹å®šç¼“å­˜
revalidateTag("admin-stats");
revalidateTag("admin-users");
```

## ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

### ä¼ ç»Ÿå®¢æˆ·ç«¯æ¸²æŸ“

```
ç”¨æˆ·è®¿é—® â†’ é¡µé¢åŠ è½½ â†’ æ‰§è¡Œ JS â†’ å‘èµ· API è¯·æ±‚ â†’ ç­‰å¾…å“åº” â†’ æ¸²æŸ“æ•°æ®
æ€»æ—¶é—´: ~2-3ç§’
```

### æ–°çš„æœåŠ¡ç«¯æ¸²æŸ“ + ç¼“å­˜

```
ç”¨æˆ·è®¿é—® â†’ è¯»å–ç¼“å­˜ â†’ è¿”å›å®Œæ•´é¡µé¢
æ€»æ—¶é—´: ~200-500msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰

é¦–æ¬¡è®¿é—® â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ ç¼“å­˜ â†’ è¿”å›é¡µé¢
æ€»æ—¶é—´: ~1-1.5ç§’ï¼ˆä»…é¦–æ¬¡ï¼‰
```

## ğŸ¨ UI æ”¹è¿›

- âœ… æ·»åŠ æ¸å˜è‰²å¡ç‰‡èƒŒæ™¯
- âœ… è§’è‰²æ ‡ç­¾å½©è‰²æ˜¾ç¤ºï¼ˆADMIN=çº¢è‰²ï¼ŒEDITOR=è“è‰²ï¼ŒUSER=ç°è‰²ï¼‰
- âœ… é‚®ç®±éªŒè¯çŠ¶æ€æ˜¾ç¤º
- âœ… æ³¨å†Œæ—¶é—´æ˜¾ç¤º
- âœ… æœ€åæ›´æ–°æ—¶é—´æç¤º
- âœ… ä¼˜é›…çš„åˆ·æ–°æŒ‰é’®åŠ¨ç”»

## ğŸ” å®‰å…¨æ€§

- âœ… æœåŠ¡ç«¯æƒé™æ£€æŸ¥ï¼ˆåœ¨æ¸²æŸ“å‰éªŒè¯ï¼‰
- âœ… æ•°æ®ä¸ç»è¿‡å®¢æˆ·ç«¯ API
- âœ… å‡å°‘æ”»å‡»é¢ï¼ˆæ— å®¢æˆ·ç«¯æ•°æ®è·å–é€»è¾‘ï¼‰
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

```
[2025-12-23 10:30:45] [INFO] Fetching admin dashboard data
[2025-12-23 10:30:45] [DB] Fetching admin stats
[2025-12-23 10:30:45] [DB] Fetching admin users list
[2025-12-23 10:30:46] [SUCCESS] Admin stats fetched successfully
[2025-12-23 10:30:46] [SUCCESS] Fetched 5 users
[2025-12-23 10:30:46] [SUCCESS] Admin page: Rendering dashboard for admin@example.com
```

## ğŸš¦ æµ‹è¯•å»ºè®®

1. **é¦–æ¬¡åŠ è½½æµ‹è¯•**

   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   - è®¿é—® `/admin`
   - æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°æ•°æ®åº“æŸ¥è¯¢

2. **ç¼“å­˜æµ‹è¯•**

   - 60 ç§’å†…åˆ·æ–°é¡µé¢
   - ä¸åº”è¯¥çœ‹åˆ°æ–°çš„æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—
   - é¡µé¢åŠ è½½åº”è¯¥éå¸¸å¿«

3. **æ‰‹åŠ¨åˆ·æ–°æµ‹è¯•**

   - ç‚¹å‡»"åˆ·æ–°æ•°æ®"æŒ‰é’®
   - åº”è¯¥çœ‹åˆ°åŠ è½½åŠ¨ç”»
   - æ•°æ®åº”è¯¥ç«‹å³æ›´æ–°

4. **è‡ªåŠ¨åˆ·æ–°æµ‹è¯•**
   - ä¿æŒé¡µé¢æ‰“å¼€è¶…è¿‡ 60 ç§’
   - åˆ·æ–°é¡µé¢
   - åº”è¯¥çœ‹åˆ°æ–°çš„æ•°æ®åº“æŸ¥è¯¢

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–

- [ ] ä½¿ç”¨ Redis æ›¿ä»£å†…å­˜ç¼“å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] å®ç°å¢é‡æ›´æ–°ï¼ˆåªåˆ·æ–°å˜åŒ–çš„æ•°æ®ï¼‰
- [ ] æ·»åŠ å®æ—¶ WebSocket é€šçŸ¥
- [ ] å®ç°åˆ†é¡µå’Œæœç´¢åŠŸèƒ½
- [ ] æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ•°æ®ä¸æ›´æ–°

**æ£€æŸ¥é¡¹ï¼š**

1. ç¡®è®¤ `revalidate` å€¼è®¾ç½®æ­£ç¡®
2. æ£€æŸ¥æœåŠ¡å™¨æ—¶é—´æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

**è§£å†³æ–¹æ¡ˆï¼š**

```typescript
// ä¸´æ—¶ç¦ç”¨ç¼“å­˜è¿›è¡Œæµ‹è¯•
export const revalidate = 0;
```

### é—®é¢˜ï¼šåˆ·æ–°æŒ‰é’®ä¸å·¥ä½œ

**æ£€æŸ¥é¡¹ï¼š**

1. ç¡®è®¤ `refresh-button.tsx` æ˜¯å®¢æˆ·ç«¯ç»„ä»¶
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**

- ç¡®ä¿æ–‡ä»¶é¡¶éƒ¨æœ‰ `"use client"`
- æ£€æŸ¥ Next.js ç‰ˆæœ¬æ˜¯å¦æ”¯æŒ `router.refresh()`

---

**ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-12-23  
**ç»´æŠ¤è€…**: AI Assistant
